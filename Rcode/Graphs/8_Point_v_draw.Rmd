---
title: "Point vs draw"
output: html_document
---
```{r setup, include=FALSE}
library(tidyverse)
library(MLmetrics)
```

```{r}
aux.folder = '../auxiliary/'
source(paste(aux.folder,'MVN_imputation.R',sep=''), chdir = T)
source(paste(aux.folder,'generate_missing.R',sep=''), chdir = T)
source(paste(aux.folder,'prediction_methods.R',sep=''), chdir = T)
source(paste(aux.folder,'simulation_methods.R',sep=''), chdir = T)
data_folder = '../../Data/'
dataset = 'abalone'


seed = ceiling(runif(1,1e3,1e5))
print(seed)
seed.run = 123
``` 

```{r}
rowMedians = function(X){
  return(apply(X,1,median))
}
```
```{r}
oneRun = function(args){
  for(name in names(args)){
    assign(name, args[[name]])
  }
  if(exists('seed.run')){
    set.seed(seed.run)
    print('seeded')
    print(seed.run)
  }
  X = X.gen(args)
  y.g = y.gen(X,args)
  
  y = y.g$y
  X = y.g$X
  

  
  spl = train_test_split(X, y, train_prop)
  X.train = spl$X.train
  X.test = spl$X.test
  y.train = spl$y.train
  y.test = spl$y.test
  
  X.train = MCAR.noEmptyLines(X.train, miss_prop)
  X.test = MCAR.noEmptyLines(X.test, miss_prop)
  
  pre.train = prelim.norm2(X.train) 
  pre.test = prelim.norm2(X.test)
  imp.train = em.norm(pre.train)
  
  
  X.train.single.imp = imp.mvnorm.estim(list(thetahat=imp.train,params=getparam.norm(pre.train,imp.train)),X.train)
  X.test.single.imp = imp.mvnorm.estim(list(thetahat=imp.train,params=getparam.norm(pre.train,imp.train)),X.test)
  
    print(head(X.test.single.imp))
  
  imp.train.BS = list()
  for(i in 1:m){
    in.BS = base::sample(1:nrow(X.train), nrow(X.train), replace=T)
    X.train.BS = X.train[in.BS,]
    pre.BS = prelim.norm2(X.train.BS)
    imp.train.BS[[i]] = em.norm(pre.BS)
  }
  

  datasets.train = list()
  datasets.test = list()
  datasets.train.BS = list()
  datasets.test.BS = list()
  for(i in 1:m){
    datasets.train[[i]] = imp.norm(pre.train,imp.train,X.train)
    datasets.test[[i]] = imp.norm(pre.test, imp.train, X.test)
    datasets.train.BS[[i]] = imp.norm(pre.train,imp.train.BS[[i]], X.train)
    datasets.test.BS[[i]] = imp.norm(pre.test, imp.train.BS[[i]], X.test)
  }
  
  single.imp.fit = (predictor$train)(X.train.single.imp, y.train)
  MI.regressors.fit = lapply(1:m,
                          function(i) {(predictor$train)(datasets.train[[i]], y.train)})
  BS.regressors.fit = lapply(1:m,
                          function(i) {(predictor$train)(datasets.train.BS[[i]], y.train)})
  predictions = list()
  predictions$MI = lapply(1:m, function(i){(predictor$predict)(MI.regressors.fit[[i]], datasets.test[[i]])}) %>% as.data.frame() %>%rowMedians() # rowMeans()
  predictions$SI = lapply(1:m, function(i){(predictor$predict)(single.imp.fit, datasets.test[[i]])}) %>% as.data.frame() %>%rowMedians() # rowMeans()
  predictions$BS = lapply(1:m, function(i){(predictor$predict)(BS.regressors.fit[[i]], datasets.test.BS[[i]])}) %>% as.data.frame() %>% rowMedians() #rowMeans()
  predictions$SIBS = lapply(1:m, function(i){(predictor$predict)(single.imp.fit, datasets.test.BS[[i]])}) %>% as.data.frame() %>% rowMedians() #rowMeans()
  predictions$point = (predictor$predict)(single.imp.fit, X.test.single.imp)
  
  
  return(lapply(predictions, function(x) mean((x-y.test)^2)))
}

```
```{r}
X.gen = X.basic.MVN
y.gen = y.regression
predictor = reg.lin
argsL = list(n=1000,
            p=5,
            rho=0.5,
            sigma_reg = 0.2,
            train_prop=0.6,
            miss_prop=0.3,
            alpha = 0.3,
            m=c(2,3,4,seq(5,50,5))
)

S = 10
res.1 = evaluate.S.run.multiArg(S,argsL, oneRun, do.parallel = T) 
```

```{r}
res.1 %>% gather('method','error', c(MI,SI, BS,SIBS,point)) %>%
  ggplot() + aes(x=m, y=error, color=method) + geom_line()
```

```{r}
X.gen = X.abalone
y.gen = y.abalone
predictor = reg.lin
argsL = list(n=1000,
            p=5,
            rho=0.5,
            sigma_reg = 0.2,
            train_prop=0.6,
            miss_prop=0.3,
            alpha = 0.3,
            m=c(2,3,4,seq(5,50,5))
)

S = 10
res.2 = evaluate.S.run.multiArg(S,argsL, oneRun, do.parallel = T) 
```

```{r}
res.2 %>% gather('method','error', c(MI,SI, BS,SIBS,point)) %>%
  ggplot() + aes(x=m, y=error, color=method) + geom_line()
```


