## Miscellaneous setup
Imports
```{r, results="hide", message=FALSE}
## Imports
library(tidyverse)
library(verification)
library(missMDA)
library(FactoMineR)
# Custom imports
aux.folder = '../../auxiliary/'
source(paste(aux.folder,'dataloaders.R',sep=''), chdir = T)
source(paste(aux.folder,'generate_missing.R',sep=''), chdir = T)
source(paste(aux.folder,'imputation_methods.R',sep=''), chdir = T)
source(paste(aux.folder,'prediction_methods.R',sep=''), chdir = T)

data_folder = '../../../Data/'
```

Parameters for this run
```{r}
#Global seed
seed = 2
# Dataset to use for the analysis
dataset = 'trauma'
# Number of datasets generated via multiple imputation
n_imputations = 40
# Prediction method used on the competed datasets
prediction_method = 'logit'
# Proportion of observations used to train the models (the rest is used for evaluation)
train_size = 0.4
# Maximum number of rows to keep in the dataset. Keep all rows if NULL
max_rows = NULL

prop_added_missing = 0.2

keep_data = 'num' # all, cat or num
imputation_methods = c('mi', 'mice', 'amelia', 'mean') #any method accepted by the *impute* method from prediction_methods.R


set.seed(seed)
```

```{r}
# Rows of the trauma dataset to keep. The first set of columns is for the numeric variables as in Wei's work. The second is 
# from an empirical evaluation of useful features for the prediction
keepCols_num = c("Age", "Glasgow.moteur.initial", "FC.max", "Hemocue.init",
                 "Remplissage.total.cristalloides","Remplissage.total.colloides", "SD.min", "SD.SMUR")
keepCols_all = c("SD.min", "FC.max", "Hemocue.init", 
                     "Age", "BMI", "Catecholamines", "Remplissage.total.cristalloides", 
                     "Poids", "Remplissage.total.colloides", "Taille", "FC.SMUR", 
                     "SD.SMUR", "TC.incarceration", "SpO2.min", "TA.ischemie", "TA.amputation", 
                     "Glasgow.initial", "TC.ecrase.projete", "Glasgow.moteur.initial", 
                     "TC.chute")
```

## Data preparation
Import and select columns

```{r}
# Load and format the dataset
dat = loader(dataset, max_rows, seed)
y = dat$y

# Keep relevant columns
if(keep_data == 'all'){
  X = cbind(dat$X_numeric, dat$X_category)
  if(dataset=='trauma'){
    X = X %>% dplyr::select(-Discordance) # Discordance has a strange correlation with y, it is removed (illustrated above)
    X = X %>% dplyr::select(one_of(keepCols_all)) 
  }
}else if(keep_data == 'cat'){
  print('Keeping only categorical variables')
  X = dat$X_category
}else if(keep_data=='num'){
  print('Keeping only numerical variables')
  X = dat$X_numeric
  if(dataset=='trauma'){
    X = X %>% dplyr::select(one_of(keepCols_num))
  }
}else{
  stop('wrong keep_data value')
}


X = MCAR(X, prop_added_missing)

print(paste('X is of dimension', toString(dim(X))))
```


##########################################

```{r}
if(keep_data=='num'){
  X_imputed = imputePCA(X)
  x.pca.imp = PCA(X_imputed$completeObs)
  ggplot() + aes(x=x.pca.imp$ind$coord[,1], y=x.pca.imp$ind$coord[,2], color=y) + geom_point()
}
```

```{r}
if(keep_data=='num'){
  x.pca = PCA(X)
  ggplot() + aes(x=x.pca$ind$coord[,1], y=x.pca$ind$coord[,2], color=y) + geom_point()
}
```
```{r}

splitted = train_test_split(X,y,train_size,seed=seed)
spl = splitted$spl

X_fill_MI = impute(X, 'mice', m=n_imputations)
y_pred_MI = multiple_prediction(X_fill_MI, y, pred_method = prediction_method, 
                                  train_size = train_size, seed=seed, spl=spl)
```
```{r}
res = data.frame(y_pred_MI$y_pred)
p = PCA(res)

preds_variable_m = matrix(NA, nrow=length(y)-length(spl), ncol=n_imputations-1)
for(i in 2:n_imputations){
  print(i)
  preds_variable_m[,i-1] = pool_MI_binary(preds=list(y_pred=y_pred_MI$y_pred[1:i]), spl=spl, method = 'mean', y_true=y, quantile.split = 0.5)
}
colnames(preds_variable_m) = 2:n_imputations
plot(apply(preds_variable_m, 2, function(x){weighted_log_loss(x,y[-spl], y[spl])}))
```
```{r}
plot(apply(preds_variable_m, 2, function(x){roc.area(as.numeric(y[-spl])-1,x)$A}))
```

```{r}
plot(apply(preds_variable_m, 2, function(x){metric_best_separation(x,y[-spl], 1)$val}))
```

